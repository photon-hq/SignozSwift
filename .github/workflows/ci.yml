name: CI

on:
  pull_request:
    types: [opened, synchronize]
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  macOS:
    runs-on: macos-15-intel
    steps:
      - uses: actions/checkout@v4
      - name: Install and start OrbStack
        run: |
          curl -fSL -o /tmp/OrbStack.dmg https://cdn-updates.orbstack.dev/amd64/OrbStack_v1.5.1_16857_amd64.dmg
          hdiutil attach /tmp/OrbStack.dmg -nobrowse -mountpoint /Volumes/OrbStack
          cp -R "/Volumes/OrbStack/OrbStack.app" /Applications/
          hdiutil detach /Volumes/OrbStack
          open -a OrbStack
          while ! docker info >/dev/null 2>&1; do sleep 2; done
      - name: Start OTel Collector
        run: |
          docker run -d --name otel-collector \
            -p 4317:4317 \
            -v ${{ github.workspace }}/otel-collector-config.yaml:/etc/otelcol/config.yaml \
            otel/opentelemetry-collector:latest
      - name: Build and test
        run: swift test
      - name: Stop OTel Collector
        if: always()
        run: docker rm -f otel-collector

  linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.2'
      - name: Start OTel Collector
        run: |
          docker run -d --name otel-collector \
            -p 4317:4317 \
            -v ${{ github.workspace }}/otel-collector-config.yaml:/etc/otelcol/config.yaml \
            otel/opentelemetry-collector:latest
      - name: Build and test
        run: swift test
      - name: Stop OTel Collector
        if: always()
        run: docker rm -f otel-collector
